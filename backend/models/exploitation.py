"""
Modèles pour les exploitations agricoles et parcelles
"""
from database import db
from datetime import datetime

class Exploitation(db.Model):
    """Exploitation agricole"""
    __tablename__ = 'exploitations'
    
    id = db.Column(db.Integer, primary_key=True)
    nom = db.Column(db.String(200), nullable=False)
    localisation_texte = db.Column(db.String(500))  # Description textuelle
    latitude = db.Column(db.Float)  # Coordonnées GPS facultatives
    longitude = db.Column(db.Float)
    superficie_totale = db.Column(db.Float, nullable=False)  # en hectares
    type_culture_principal = db.Column(db.String(100))
    historique_cultural = db.Column(db.Text)  # Historique libre
    proprietaire_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # Relations
    parcelles = db.relationship('Parcelle', backref='exploitation', lazy=True, cascade='all, delete-orphan')
    analyses_sols = db.relationship('AnalyseSol', backref='exploitation', lazy=True)
    intrants = db.relationship('Intrant', backref='exploitation', lazy=True)
    
    def to_dict(self):
        return {
            'id': self.id,
            'nom': self.nom,
            'localisation_texte': self.localisation_texte,
            'latitude': self.latitude,
            'longitude': self.longitude,
            'superficie_totale': self.superficie_totale,
            'type_culture_principal': self.type_culture_principal,
            'historique_cultural': self.historique_cultural,
            'proprietaire_id': self.proprietaire_id,
            'proprietaire': self.proprietaire.to_dict() if self.proprietaire else None,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None,
            'parcelles_count': len(self.parcelles) if self.parcelles else 0
        }

class Parcelle(db.Model):
    """Parcelle d'une exploitation"""
    __tablename__ = 'parcelles'
    
    id = db.Column(db.Integer, primary_key=True)
    nom = db.Column(db.String(200), nullable=False)
    superficie = db.Column(db.Float, nullable=False)  # en hectares
    type_culture = db.Column(db.String(100))
    exploitation_id = db.Column(db.Integer, db.ForeignKey('exploitations.id'), nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # Relations
    analyses_sols = db.relationship('AnalyseSol', backref='parcelle', lazy=True)
    intrants = db.relationship('Intrant', backref='parcelle', lazy=True)
    
    def to_dict(self):
        return {
            'id': self.id,
            'nom': self.nom,
            'superficie': self.superficie,
            'type_culture': self.type_culture,
            'exploitation_id': self.exploitation_id,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }

