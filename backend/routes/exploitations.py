"""
Routes pour la gestion des exploitations agricoles
"""
from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
from database import db
from models.exploitation import Exploitation
from utils.historique import log_action

exploitations_bp = Blueprint('exploitations', __name__)

@exploitations_bp.route('', methods=['GET'])
@jwt_required()
def get_exploitations():
    """Liste toutes les exploitations"""
    try:
        user_id = get_jwt_identity()
        # Filtrer par propriétaire ou toutes si admin
        exploitations = Exploitation.query.filter_by(proprietaire_id=user_id).all()
        return jsonify([exp.to_dict() for exp in exploitations]), 200
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@exploitations_bp.route('', methods=['POST'])
@jwt_required()
def create_exploitation():
    """Créer une nouvelle exploitation"""
    try:
        user_id = get_jwt_identity()
        data = request.get_json()
        
        if not data.get('nom') or not data.get('superficie_totale'):
            return jsonify({'error': 'Nom et superficie sont requis'}), 400
        
        exploitation = Exploitation(
            nom=data['nom'],
            localisation_texte=data.get('localisation_texte'),
            latitude=data.get('latitude'),
            longitude=data.get('longitude'),
            superficie_totale=data['superficie_totale'],
            type_culture_principal=data.get('type_culture_principal'),
            historique_cultural=data.get('historique_cultural'),
            proprietaire_id=user_id
        )
        
        db.session.add(exploitation)
        db.session.commit()
        
        log_action(user_id, 'create', 'exploitation', exploitation.id, {'nom': exploitation.nom})
        
        return jsonify({
            'message': 'Exploitation créée avec succès',
            'exploitation': exploitation.to_dict()
        }), 201
        
    except Exception as e:
        db.session.rollback()
        return jsonify({'error': str(e)}), 500

@exploitations_bp.route('/<int:exploitation_id>', methods=['GET'])
@jwt_required()
def get_exploitation(exploitation_id):
    """Récupérer une exploitation par ID"""
    try:
        exploitation = Exploitation.query.get(exploitation_id)
        if not exploitation:
            return jsonify({'error': 'Exploitation non trouvée'}), 404
        return jsonify(exploitation.to_dict()), 200
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@exploitations_bp.route('/<int:exploitation_id>', methods=['PUT'])
@jwt_required()
def update_exploitation(exploitation_id):
    """Mettre à jour une exploitation"""
    try:
        user_id = get_jwt_identity()
        exploitation = Exploitation.query.get(exploitation_id)
        
        if not exploitation:
            return jsonify({'error': 'Exploitation non trouvée'}), 404
        
        if exploitation.proprietaire_id != user_id:
            return jsonify({'error': 'Non autorisé'}), 403
        
        data = request.get_json()
        
        if 'nom' in data:
            exploitation.nom = data['nom']
        if 'localisation_texte' in data:
            exploitation.localisation_texte = data['localisation_texte']
        if 'latitude' in data:
            exploitation.latitude = data['latitude']
        if 'longitude' in data:
            exploitation.longitude = data['longitude']
        if 'superficie_totale' in data:
            exploitation.superficie_totale = data['superficie_totale']
        if 'type_culture_principal' in data:
            exploitation.type_culture_principal = data['type_culture_principal']
        if 'historique_cultural' in data:
            exploitation.historique_cultural = data['historique_cultural']
        
        db.session.commit()
        
        log_action(user_id, 'update', 'exploitation', exploitation_id, data)
        
        return jsonify({
            'message': 'Exploitation mise à jour avec succès',
            'exploitation': exploitation.to_dict()
        }), 200
        
    except Exception as e:
        db.session.rollback()
        return jsonify({'error': str(e)}), 500

@exploitations_bp.route('/<int:exploitation_id>', methods=['DELETE'])
@jwt_required()
def delete_exploitation(exploitation_id):
    """Supprimer une exploitation"""
    try:
        user_id = get_jwt_identity()
        exploitation = Exploitation.query.get(exploitation_id)
        
        if not exploitation:
            return jsonify({'error': 'Exploitation non trouvée'}), 404
        
        if exploitation.proprietaire_id != user_id:
            return jsonify({'error': 'Non autorisé'}), 403
        
        db.session.delete(exploitation)
        db.session.commit()
        
        log_action(user_id, 'delete', 'exploitation', exploitation_id, {'nom': exploitation.nom})
        
        return jsonify({'message': 'Exploitation supprimée avec succès'}), 200
        
    except Exception as e:
        db.session.rollback()
        return jsonify({'error': str(e)}), 500

