import 'package:flutter_test/flutter_test.dart';
import 'package:mockito/mockito.dart';
import 'package:mockito/annotations.dart';

import 'package:agrigeo/presentation/providers/exploitation_provider.dart';
import 'package:agrigeo/data/repositories/exploitation_repository.dart';
import 'package:agrigeo/data/models/exploitation_model.dart';
import 'package:agrigeo/core/errors/failures.dart';

import 'test_exploitation_provider.mocks.dart';

@GenerateMocks([ExploitationRepository])
void main() {
  group('ExploitationProvider', () {
    late ExploitationProvider provider;
    late MockExploitationRepository mockRepository;

    setUp(() {
      mockRepository = MockExploitationRepository();
      provider = ExploitationProvider(repository: mockRepository);
    });

    test('initial state should be empty', () {
      expect(provider.exploitations, isEmpty);
      expect(provider.isLoading, false);
      expect(provider.error, isNull);
    });

    test('loadExploitations should populate exploitations on success', () async {
      // Arrange
      final exploitations = [
        ExploitationModel(
          id: 1,
          nom: 'Ferme 1',
          superficieTotale: 10.5,
          proprietaireId: 1,
          isActive: true,
          roleId: 1,
          username: 'user1',
          email: 'user1@example.com',
        ),
        ExploitationModel(
          id: 2,
          nom: 'Ferme 2',
          superficieTotale: 15.0,
          proprietaireId: 1,
          isActive: true,
          roleId: 1,
          username: 'user1',
          email: 'user1@example.com',
        ),
      ];

      when(mockRepository.getExploitations())
          .thenAnswer((_) async => exploitations);

      // Act
      await provider.loadExploitations();

      // Assert
      expect(provider.exploitations.length, 2);
      expect(provider.exploitations[0].nom, 'Ferme 1');
      expect(provider.isLoading, false);
      expect(provider.error, isNull);
    });

    test('loadExploitations should set error on failure', () async {
      // Arrange
      when(mockRepository.getExploitations())
          .thenThrow(ServerFailure('Erreur serveur'));

      // Act
      await provider.loadExploitations();

      // Assert
      expect(provider.exploitations, isEmpty);
      expect(provider.error, isNotNull);
      expect(provider.error, contains('Erreur'));
    });

    test('createExploitation should add exploitation on success', () async {
      // Arrange
      final newExploitation = ExploitationModel(
        id: 1,
        nom: 'Nouvelle Ferme',
        superficieTotale: 20.0,
        proprietaireId: 1,
        isActive: true,
        roleId: 1,
        username: 'user1',
        email: 'user1@example.com',
      );

      final data = {
        'nom': 'Nouvelle Ferme',
        'superficie_totale': 20.0,
      };

      when(mockRepository.createExploitation(data))
          .thenAnswer((_) async => newExploitation);

      // Act
      final result = await provider.createExploitation(data);

      // Assert
      expect(result, true);
      expect(provider.exploitations.length, 1);
      expect(provider.exploitations[0].nom, 'Nouvelle Ferme');
    });

    test('updateExploitation should update existing exploitation', () async {
      // Arrange
      final exploitation = ExploitationModel(
        id: 1,
        nom: 'Ferme Originale',
        superficieTotale: 10.0,
        proprietaireId: 1,
        isActive: true,
        roleId: 1,
        username: 'user1',
        email: 'user1@example.com',
      );

      provider.exploitations.add(exploitation);

      final updatedExploitation = ExploitationModel(
        id: 1,
        nom: 'Ferme Modifiée',
        superficieTotale: 15.0,
        proprietaireId: 1,
        isActive: true,
        roleId: 1,
        username: 'user1',
        email: 'user1@example.com',
      );

      final data = {'nom': 'Ferme Modifiée'};

      when(mockRepository.updateExploitation(1, data))
          .thenAnswer((_) async => updatedExploitation);

      // Act
      final result = await provider.updateExploitation(1, data);

      // Assert
      expect(result, true);
      expect(provider.exploitations[0].nom, 'Ferme Modifiée');
    });

    test('deleteExploitation should remove exploitation on success', () async {
      // Arrange
      final exploitation = ExploitationModel(
        id: 1,
        nom: 'Ferme à Supprimer',
        superficieTotale: 10.0,
        proprietaireId: 1,
        isActive: true,
        roleId: 1,
        username: 'user1',
        email: 'user1@example.com',
      );

      provider.exploitations.add(exploitation);

      when(mockRepository.deleteExploitation(1))
          .thenAnswer((_) async => {});

      // Act
      final result = await provider.deleteExploitation(1);

      // Assert
      expect(result, true);
      expect(provider.exploitations, isEmpty);
    });
  });
}

