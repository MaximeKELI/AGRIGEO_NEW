import 'package:flutter/foundation.dart';
import '../../core/errors/failures.dart';
import '../../data/models/exploitation_model.dart';
import '../../data/repositories/exploitation_repository.dart';

class ExploitationProvider with ChangeNotifier {
  final ExploitationRepository _repository;
  List<ExploitationModel> _exploitations = [];
  bool _isLoading = false;
  String? _error;

  ExploitationProvider({ExploitationRepository? repository})
      : _repository = repository ?? ExploitationRepository();

  List<ExploitationModel> get exploitations => _exploitations;
  bool get isLoading => _isLoading;
  String? get error => _error;

  Future<void> loadExploitations() async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      _exploitations = await _repository.getExploitations();
      _isLoading = false;
      notifyListeners();
    } on Failure catch (e) {
      _error = e.message;
      _isLoading = false;
      notifyListeners();
    } catch (e) {
      _error = 'Erreur inattendue: ${e.toString()}';
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<bool> createExploitation(Map<String, dynamic> data) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      final exploitation = await _repository.createExploitation(data);
      _exploitations.add(exploitation);
      _isLoading = false;
      notifyListeners();
      return true;
    } on Failure catch (e) {
      _error = e.message;
      _isLoading = false;
      notifyListeners();
      return false;
    } catch (e) {
      _error = 'Erreur inattendue: ${e.toString()}';
      _isLoading = false;
      notifyListeners();
      return false;
    }
  }

  Future<bool> updateExploitation(int id, Map<String, dynamic> data) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      final exploitation = await _repository.updateExploitation(id, data);
      final index = _exploitations.indexWhere((e) => e.id == id);
      if (index != -1) {
        _exploitations[index] = exploitation;
      }
      _isLoading = false;
      notifyListeners();
      return true;
    } on Failure catch (e) {
      _error = e.message;
      _isLoading = false;
      notifyListeners();
      return false;
    } catch (e) {
      _error = 'Erreur inattendue: ${e.toString()}';
      _isLoading = false;
      notifyListeners();
      return false;
    }
  }

  Future<bool> deleteExploitation(int id) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      await _repository.deleteExploitation(id);
      _exploitations.removeWhere((e) => e.id == id);
      _isLoading = false;
      notifyListeners();
      return true;
    } on Failure catch (e) {
      _error = e.message;
      _isLoading = false;
      notifyListeners();
      return false;
    } catch (e) {
      _error = 'Erreur inattendue: ${e.toString()}';
      _isLoading = false;
      notifyListeners();
      return false;
    }
  }

  void clearError() {
    _error = null;
    notifyListeners();
  }
}

